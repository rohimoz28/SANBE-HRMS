stages:
  - build
  - deploy
  - notify

variables:
  PROJECT_DIR: "/opt/docker-odoo-sanbe/docker-odoo-131/develop/customize/sanbe-hrms/"
  DOCKER_SERVICE: "sanbe-hrms"
  RESTART_FLAG: "/tmp/restart_docker.lock"

image: alpine:latest

before_script:
  - apk add --no-cache openssh-client curl wget tzdata dos2unix bash
  - ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
  - chmod 600 /tmp/deploy_key
  - ssh-add /tmp/deploy_key
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
  - mkdir -p /tmp/scripts
  - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
  - |
    if [ -f "/tmp/scripts/send_notification.sh" ]; then
      echo "‚úÖ File successfully copied."
      chmod +x /tmp/scripts/send_notification.sh
      dos2unix /tmp/scripts/send_notification.sh
      tr -d '\r' < /tmp/scripts/send_notification.sh > /tmp/scripts/send_notification_fixed.sh
      mv /tmp/scripts/send_notification_fixed.sh /tmp/scripts/send_notification.sh
      chmod +x /tmp/scripts/send_notification.sh
    else
      echo "‚ùå Error: /tmp/scripts/send_notification.sh not found!"
      exit 1
    fi

update_project:
  stage: build
  tags:
    - test4
  script:
    - echo "Deploying latest updates via SSH..."
    - |
      ssh -i /tmp/deploy_key $SSH_USER@$DEPLOY_SERVER "
      if [ -d '$PROJECT_DIR' ]; then
        echo 'Project directory exists. Pulling latest changes...';
        cd '$PROJECT_DIR' && git pull origin staging
        if [ $? -ne 0 ]; then # Check the exit code of the git pull command
          echo 'Error: Failed to pull from origin/staging'
          exit 1
        fi
        echo 'Success to pull newest project';
        echo '$(date +%s)' > '$RESTART_FLAG';
      else
        echo 'Error: Project directory does not exist!';
        exit 1;
      fi
      "
  only:
    - staging

restart_apps_scheduled:
  stage: deploy
  tags:
    - test4
  before_script:
    - apk add --no-cache openssh-client curl wget
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
    - chmod 600 /tmp/deploy_key
    - ssh-add /tmp/deploy_key
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - mkdir -p /tmp/scripts
    - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
    - |
      if [ -f "/tmp/scripts/send_notification.sh" ]; then
      echo "File successfully copied."
      chmod +x /tmp/scripts/send_notification.sh
      dos2unix /tmp/scripts/send_notification.sh
      else
      echo "Error: /tmp/scripts/send_notification.sh not found!"
      exit 1
      fi
  script:
    - echo "running scheduled restart!"
    - |
      ssh -i /tmp/deploy_key $SSH_USER@$DEPLOY_SERVER "
      if [ -d '$PROJECT_DIR' ]; then
        echo 'Restarting Application...';
        docker container restart "$DOCKER_SERVICE"
        if [ $? -ne 0 ]; then # Check the exit code of the git pull command
          echo 'Error: Application Restart Failed!'
          exit 1
        fi
        echo 'Application Restarted Successfully!';
      else
        echo 'Error: Project directory does not exist!';
        exit 1;
      fi
      "
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_BRANCH == "main"'

success_notif_scheduled:
  stage: notify
  image: alpine:latest
  tags:
    - test4
  before_script:
    - apk add --no-cache tzdata # Add this line
    - ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime # Set the timezone
    - apk add --no-cache curl wget jq dos2unix bash openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
    - chmod 600 /tmp/deploy_key
    - ssh-add /tmp/deploy_key
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - mkdir -p /tmp/scripts
    - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
    - |
      if [ -f "/tmp/scripts/send_notification.sh" ]; then
        echo "File successfully copied."
        chmod +x /tmp/scripts/send_notification.sh
        dos2unix /tmp/scripts/send_notification.sh
      else
        echo "Error: /tmp/scripts/send_notification.sh not found!"
        exit 1
      fi
  script:
    - echo "Executing notification script..."
    - TZ="Asia/Jakarta" /tmp/scripts/send_notification.sh "‚úÖ Deployment Successful!" "Success" 3066993 "SANBE HRMS - STAGING" "$WEBHOOK_URL"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_BRANCH == "main"'
  needs:
    - job: restart_apps_scheduled
      optional: false # Ensures this notification only runs if the manual deployment runs
  when: on_success

failure_notification_scheduled:
  stage: notify
  image: alpine:latest
  tags:
    - test4
  before_script:
    - apk add --no-cache curl wget jq dos2unix bash openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
    - chmod 600 /tmp/deploy_key
    - ssh-add /tmp/deploy_key
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - mkdir -p /tmp/scripts
    - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
    - |
      if [ -f "/tmp/scripts/send_notification.sh" ]; then
        echo "File successfully copied."
        chmod +x /tmp/scripts/send_notification.sh
        dos2unix /tmp/scripts/send_notification.sh
      else
        echo "Error: /tmp/scripts/send_notification.sh not found!"
        exit 1
      fi
  script:
    - echo "Executing notification script..."
    - TZ="Asia/Jakarta" /tmp/scripts/send_notification.sh "‚ùå Deployment Failed!" "Failed" 15552000 "SANBE HRMS - STAGING" "$WEBHOOK_URL"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $CI_COMMIT_BRANCH == "main"'
  needs:
    - job: restart_apps_scheduled
      optional: false # Ensures this notification only runs if the manual deployment runs
  when: on_failure

restart_apps_manual:
  stage: deploy
  tags:
    - test4
  before_script:
    - apk add --no-cache tzdata # Add this line
    - ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime # Set the timezone
    - apk add --no-cache openssh-client curl wget dos2unix bash
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
    - chmod 600 /tmp/deploy_key
    - ssh-add /tmp/deploy_key
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - mkdir -p /tmp/scripts
    - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
    - |
      if [ -f "/tmp/scripts/send_notification.sh" ]; then
        echo "‚úÖ File successfully copied."
        chmod +x /tmp/scripts/send_notification.sh
        dos2unix /tmp/scripts/send_notification.sh
        tr -d '\r' < /tmp/scripts/send_notification.sh > /tmp/scripts/send_notification_fixed.sh
        mv /tmp/scripts/send_notification_fixed.sh /tmp/scripts/send_notification.sh
        chmod +x /tmp/scripts/send_notification.sh
      else
        echo "‚ùå Error: /tmp/scripts/send_notification.sh not found!"
        exit 1
      fi
  script:
    - echo "üöÄ Running urgent restart!"
    - echo "üìå Webhook URL= $WEBHOOK_URL"
    - |
      ssh -i /tmp/deploy_key $SSH_USER@$DEPLOY_SERVER "
      if [ -d '$PROJECT_DIR' ]; then
        echo 'üîÑ Restarting Application...';
        docker container restart \"$DOCKER_SERVICE\"
        if [ $? -ne 0 ]; then
          echo '‚ùå Error: Application Restart Failed!';
          exit 1
        fi
        echo '‚úÖ Application Restarted Successfully!';
      else
        echo '‚ùå Error: Project directory does not exist!';
        exit 1;
      fi
      "
  only:
    - staging
  when: manual

success_notif_manual:
  stage: notify
  image: alpine:latest
  tags:
    - test4
  before_script:
    - apk add --no-cache tzdata # Add this line
    - ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime # Set the timezone
    - apk add --no-cache curl wget jq dos2unix bash openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
    - chmod 600 /tmp/deploy_key
    - ssh-add /tmp/deploy_key
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - mkdir -p /tmp/scripts
    - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
    - |
      if [ -f "/tmp/scripts/send_notification.sh" ]; then
        echo "‚úÖ File successfully copied."
        chmod +x /tmp/scripts/send_notification.sh
        dos2unix /tmp/scripts/send_notification.sh
        tr -d '\r' < /tmp/scripts/send_notification.sh > /tmp/scripts/send_notification_fixed.sh
        mv /tmp/scripts/send_notification_fixed.sh /tmp/scripts/send_notification.sh
        chmod +x /tmp/scripts/send_notification.sh
      else
        echo "‚ùå Error: /tmp/scripts/send_notification.sh not found!"
        exit 1
      fi
  script:
    - echo "üì¢ Sending notification to Discord..."
    - ls -lah /tmp/scripts/
    - cat -A /tmp/scripts/send_notification.sh # Debug script content
    - TZ="Asia/Jakarta" /tmp/scripts/send_notification.sh "‚úÖ Manual Deployment Successful!" "Success" 3066993 "SANBE HRMS - STAGING" "$WEBHOOK_URL"
  needs:
    - job: restart_apps_manual
      optional: false # Ensures this notification only runs if the manual deployment runs
  only:
    - staging
  when: on_success

failure_notification_manual:
  stage: notify
  image: alpine:latest
  tags:
    - test4
  before_script:
    - apk add --no-cache tzdata # Add this line
    - ln -sf /usr/share/zoneinfo/Asia/Jakarta /etc/localtime # Set the timezone
    - apk add --no-cache curl wget jq dos2unix bash openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
    - chmod 600 /tmp/deploy_key
    - ssh-add /tmp/deploy_key
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - mkdir -p /tmp/scripts
    - scp -o StrictHostKeyChecking=no $SSH_USER@$DEPLOY_SERVER:/home/albert/script/send_notification.sh /tmp/scripts/
    - |
      if [ -f "/tmp/scripts/send_notification.sh" ]; then
        echo "File successfully copied."
        chmod +x /tmp/scripts/send_notification.sh
        dos2unix /tmp/scripts/send_notification.sh
      else
        echo "Error: /tmp/scripts/send_notification.sh not found!"
        exit 1
      fi
  script:
    - echo "Executing notification script..."
    - /tmp/scripts/send_notification.sh "‚ùå Deployment Failed!" "Failed" 15552000 "SANBE HRMS - STAGING" "$WEBHOOK_URL"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_BRANCH == "main"'
  dependencies:
    - restart_apps_scheduled
  when: on_failure